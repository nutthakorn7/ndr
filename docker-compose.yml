version: '3.8'

services:
  # Frontend
  ui:
    build: ./ui
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certs:/etc/nginx/certs:ro
    depends_on:
      - dashboard-api
    restart: always

  # Backend Services
  dashboard-api:
    build: ./services/rust-dashboard-api
    ports:
      - "8081:8081"
    environment:
      - PORT=8081
      - OPENSEARCH_URL=http://opensearch:9200
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/security_analytics
      - SENSOR_CONTROLLER_URL=http://rust-controller:8084
      - AI_SERVICE_URL=http://ai-service:8090
    depends_on:
      - opensearch
      - postgres
      - rust-controller
    restart: always

  rust-controller:
    build: ./services/rust-controller
    ports:
      - "8084:8084"
    environment:
      - PORT=8084
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/security_analytics
      - RUST_LOG=info
    depends_on:
      - postgres
    restart: always

  auth-service:
    build: ./services/rust-auth-service
    ports:
      - "8087:8087"
    environment:
      - PORT=8087
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/security_analytics
      - JWT_SECRET=ndr-demo-secret
      - ADMIN_EMAIL=admin@ndr.local
      - ADMIN_PASSWORD=admin
    depends_on:
      - postgres
    restart: always

  asset-service:
    build: ./services/rust-asset-service
    environment:
      - PORT=8080
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/security_analytics
      - KAFKA_BROKERS=kafka:9092
      - RUST_LOG=info
    depends_on:
      - postgres
      - kafka
    restart: always

  rust-soar-orchestrator:
    build: ./services/rust-soar-orchestrator
    environment:
      - KAFKA_BROKERS=kafka:9092
      - WEBHOOK_URL=http://host.docker.internal:9000/webhook
      - RUST_LOG=info
    depends_on:
      - kafka
    restart: always

  ai-service:
    build: ./services/rust-ai-service
    container_name: ai-service
    ports:
      - "8090:8090"
    environment:
      - PORT=8090
      - RUST_LOG=info
    restart: always

  ingestion-gateway:
    build: ./services/rust-ingestion-gateway
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - KAFKA_BROKERS=kafka:29092
      - KAFKA_TOPIC=raw-logs
      - RUST_LOG=info
    depends_on:
      - kafka
    restart: always

  parser-normalizer:
    build: ./services/rust-parser-normalizer
    environment:
      - KAFKA_BROKERS=kafka:9092
      - ZEEK_TOPIC=zeek-logs
      - SURICATA_TOPIC=suricata-logs
      - RUST_LOG=info
    depends_on:
      - kafka
    restart: always

  rust-alert-correlator:
    build: ./services/rust-alert-correlator
    environment:
      - KAFKA_BROKERS=kafka:9092
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgres://user:password@postgres:5432/ndr
      - RUST_LOG=info
    depends_on:
      - kafka
      - redis
      - postgres

  siem-exporter:
    build: ./services/rust-siem-exporter
    environment:
      - KAFKA_BROKERS=kafka:9092
      - SPLUNK_ENABLED=false
      - ELASTIC_ENABLED=false
      - WEBHOOK_1_ENABLED=true
      - WEBHOOK_1_URL=http://host.docker.internal:9000/webhook
      - RUST_LOG=info
    depends_on:
      - kafka
    restart: always

  rust-yara-scanner:
    build: ./services/rust-yara-scanner
    volumes:
      - ./data/extracted_files:/data/extracted_files
      # - ./services/yara-scanner/rules:/app/rules # Legacy path, commented out until rules are moved
    environment:
      - KAFKA_BROKERS=kafka:9092
      - WATCH_DIR=/data/extracted_files
      - RULES_PATH=/app/rules
      - RUST_LOG=info
    depends_on:
      - kafka

  rust-sensor:
    build: ./services/rust-sensor
    cap_add:
      - NET_ADMIN
      - NET_RAW
    # network_mode: "host" # Temporarily disabled for Mac verification
    environment:
      - RUST_LOG=info
      - KAFKA_BROKERS=kafka:29092
    restart: always

  rust-pcap-service:
    build: ./services/rust-pcap-service
    cap_add:
      - NET_ADMIN
      - NET_RAW
    network_mode: "host" # Needed for packet capture
    volumes:
      - pcap-data:/data/pcap
    environment:
      - PCAP_DIR=/data/pcap
      - CAPTURE_INTERFACE=eth0
      - PORT=8088
      - RUST_LOG=info
    restart: always
  
  # Edge Computing Services
  edge-coordinator:
    build: ./services/rust-edge-coordinator
    ports:
      - "8085:8085"
    environment:
      - PORT=8085
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/security_analytics
      - COORDINATOR_API_KEY=${COORDINATOR_API_KEY:-dev-coordinator-secret-key-change-in-production}
      - TLS_ENABLED=${COORDINATOR_TLS_ENABLED:-false}
      - TLS_CERT_PATH=/etc/edge-coordinator/tls/cert.pem
      - TLS_KEY_PATH=/etc/edge-coordinator/tls/key.pem
      - RUST_LOG=info
    volumes:
      - ./tls-certs/coordinator:/etc/edge-coordinator/tls:ro
    depends_on:
      - postgres
    restart: always

  edge-agent:
    build: ./services/rust-edge-agent
    ports:
      - "8086:8086"
    environment:
      - PORT=8086
      - EDGE_AGENT_ID=edge-agent-demo
      - EDGE_LOCATION=demo-site
      - COORDINATOR_URL=${COORDINATOR_URL:-http://edge-coordinator:8085}
      - KAFKA_BROKERS=kafka:29092
      - KAFKA_TOPIC=edge-events
      - BUFFER_DB_PATH=/var/lib/edge-agent/buffer.db
      - MAX_BUFFER_SIZE_MB=512
      - HEARTBEAT_INTERVAL_SECS=30
      - API_KEY=${EDGE_AGENT_API_KEY:-dev-agent-secret-key-change-in-production}
      - TLS_ENABLED=${AGENT_TLS_ENABLED:-false}
      - TLS_CERT_PATH=/etc/edge-agent/tls/cert.pem
      - TLS_KEY_PATH=/etc/edge-agent/tls/key.pem
      - RUST_LOG=info
    volumes:
      - edge-agent-data:/var/lib/edge-agent
      - ./tls-certs/agent:/etc/edge-agent/tls:ro
    depends_on:
      - edge-coordinator
      - kafka
    restart: always

  # Infrastructure
  suricata:
    image: jasonish/suricata:latest
    container_name: suricata
    network_mode: "host" # Linux only. On Mac/Windows, this sees VM traffic only.
    cap_add:
      - NET_ADMIN
      - SYS_NICE
      - NET_RAW
    volumes:
      - suricata-logs:/var/log/suricata
      - suricata-rules:/var/lib/suricata/rules
      - ./config/suricata:/etc/suricata
    command: -i eth0
    restart: always

  filebeat:
    image: docker.elastic.co/beats/filebeat-oss:7.12.1
    container_name: filebeat
    user: root
    volumes:
      - suricata-logs:/var/log/suricata:ro
      - ./config/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
    depends_on:
      - opensearch
      - suricata
    restart: always

  opensearch:
    image: opensearchproject/opensearch:2.11.0
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - DISABLE_SECURITY_PLUGIN=true 
    # Ports removed for security - internal only
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - opensearch-data:/usr/share/opensearch/data

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=security_analytics
    # Ports removed for security - internal only
    volumes:
      - postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    # Ports removed for security - internal only

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    restart: always

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    depends_on:
      - zookeeper
    ports:
      - "9094:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://host.docker.internal:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    restart: always

volumes:
  opensearch-data:
  postgres-data:
  suricata-logs:
  suricata-rules:
  pcap-data:
  edge-agent-data:
